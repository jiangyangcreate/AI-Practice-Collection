# KNN图像分类系统使用说明

## 项目结构

```
knn_network/
├── data/
│   ├── paper/      # 纸张类别的图像（70张）
│   └── water/      # 水面类别的图像（85张）
├── main.py         # 主程序
├── 1.jpg           # 测试图片1
├── 2.jpg           # 测试图片2
└── requirements.txt
```

## 功能说明

### 1. 数据处理 (DataProcessor)
- `read_video()`: 从视频中提取帧图像
- `extract_features()`: 从图像提取3130维特征向量
  - 颜色直方图（RGB各16 bins = 48维）
  - 全局统计特征（4维）
  - 通道统计特征（12维）
  - 降采样图像特征（32×32×3 = 3072维）

### 2. KNN模型 (Model)
- `knn_model()`: 训练KNN分类器
- `knn_predict()`: 预测图像类别
- `save_model()`: 保存模型
- `load_model()`: 加载模型

## 使用方法

### 方法1: 直接运行（自动训练和测试）

```bash
python main.py
```

程序会自动：
1. 从data文件夹加载paper和water两类图像
2. 训练KNN模型（k=5）
3. 显示训练和测试准确率
4. 保存模型到knn_model.pkl
5. 对1.jpg和2.jpg进行预测

### 方法2: 自定义使用

```python
from main import Model

# 创建模型（可以指定k值）
model = Model(k=3)

# 训练模型
results = model.knn_model(data_path="data", test_size=0.2)
print(f"测试准确率: {results['test_accuracy']:.2%}")

# 保存模型
model.save_model("my_model.pkl")

# 预测新图像
result = model.knn_predict("test_image.jpg")
print(f"预测类别: {result['class_name']}")
print(f"置信度: {result['confidence']:.2%}")
```

### 方法3: 加载已训练的模型

```python
from main import Model

# 创建模型实例
model = Model()

# 加载已保存的模型
model.load_model("knn_model.pkl")

# 直接预测
result = model.knn_predict("new_image.jpg")
print(result)
```

## 输出示例

### 训练输出
```
==================================================
开始训练KNN模型
==================================================
找到 2 个类别: ['paper', 'water']

处理类别 'paper' (标签: 0)...
  找到 70 张图片

处理类别 'water' (标签: 1)...
  找到 85 张图片

总共加载了 155 个样本
特征维度: 3130

训练集大小: 124
测试集大小: 31

标准化特征...

训练KNN模型 (k=5)...

训练集准确率: 98.39%
测试集准确率: 96.77%

各类别测试结果:
  paper: 100.00%
  water: 94.74%

==================================================
模型训练完成！
==================================================
```

### 预测输出
```
预测图片: 1.jpg
  预测类别: paper
  置信度: 92.50%
  所有概率:
    paper: 92.50%
    water: 7.50%
```

## 参数调整

### 调整K值
```python
model = Model(k=3)  # 使用3个最近邻居
```

### 调整测试集比例
```python
model.knn_model(test_size=0.3)  # 30%作为测试集
```

### 调整特征提取参数
```python
from main import DataProcessor

# 使用不同的图像大小
features = DataProcessor.extract_features(
    "image.jpg", 
    target_size=(128, 128)  # 使用128x128而不是默认的224x224
)
```

## 性能建议

1. **数据量**: 每个类别至少30张图片
2. **图像质量**: 清晰、光照良好的图像
3. **K值选择**: 
   - 小数据集: k=3~5
   - 大数据集: k=5~10
4. **类别差异**: 确保不同类别的图像有明显的视觉差异

## 常见问题

### Q: 准确率太低怎么办？
A: 
- 检查图像质量
- 尝试调整k值
- 增加训练样本
- 确保类别间有明显差异

### Q: 预测速度慢？
A:
- 减少特征维度（修改extract_features中的降采样大小）
- 使用较小的k值
- 减少训练样本

### Q: 如何添加新类别？
A:
1. 在data文件夹下创建新的类别文件夹
2. 将该类别的图像放入文件夹
3. 重新运行训练

## 技术细节

- **KNN算法**: 使用距离加权的K近邻分类
- **特征标准化**: 使用StandardScaler进行Z-score标准化
- **交叉验证**: 使用stratify确保训练/测试集类别平衡
- **概率输出**: 基于k个最近邻居的距离加权计算

## 依赖包

```
opencv-python>=4.8.0
numpy>=1.24.0
scikit-learn>=1.3.0
```

安装方法：
```bash
pip install -r requirements.txt
```

